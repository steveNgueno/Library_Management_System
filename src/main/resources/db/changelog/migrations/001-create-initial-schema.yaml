databaseChangeLog:

  # ──────────────────────────────────────────────────────────────
  #  Gender (independent lookup table)
  # ──────────────────────────────────────────────────────────────
  - changeSet:
      id: 001-gender
      author: steve
      comment: "Create genders table (categories/genres for books)"
      changes:
        - createTable:
            tableName: genders
            columns:
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: create_at
                  type: DATETIME
                  defaultValueComputed: "CURRENT_TIMESTAMP"
                  constraints:
                    nullable: false
              - column:
                  name: update_at
                  type: DATETIME
                  defaultValueComputed: "CURRENT_TIMESTAMP"
                  constraints:
                    nullable: false
              - column:
                  name: gender_name
                  type: VARCHAR(100)
                  constraints:
                    nullable: false
                    unique: true

  # ──────────────────────────────────────────────────────────────
  # Student
  # ──────────────────────────────────────────────────────────────

  - changeSet:
      id: 002-students
      author: steve
      comment: "Create students table - inherits from User"
      changes:
        - createTable:
            tableName: students
            columns:
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: create_at
                  type: DATETIME
                  defaultValueComputed: "CURRENT_TIMESTAMP"
                  constraints:
                    nullable: false
              - column:
                  name: update_at
                  type: DATETIME
                  defaultValueComputed: "CURRENT_TIMESTAMP"
                  constraints:
                    nullable: false
              - column:
                  name: firstname
                  type: VARCHAR(100)
                  constraints:
                    nullable: false
              - column:
                  name: lastname
                  type: VARCHAR(100)
              - column:
                  name: birthday
                  type: DATE
                  constraints:
                    nullable: false
              - column:
                  name: email
                  type: VARCHAR(150)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: phone_number
                  type: VARCHAR(30)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: role
                  type: VARCHAR(50)
                  constraints:
                    nullable: false
              - column:
                  name: password
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: student_id
                  type: VARCHAR(50)
              - column:
                  name: sector
                  type: VARCHAR(150)

  # ──────────────────────────────────────────────────────────────
  # Admin
  # ──────────────────────────────────────────────────────────────
  - changeSet:
      id: 003-admins
      author: steve
      comment: "Create admins table - inherits from User"
      changes:
        - createTable:
            tableName: admins
            columns:
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: create_at
                  type: DATETIME
                  defaultValueComputed: "CURRENT_TIMESTAMP"
                  constraints:
                    nullable: false
              - column:
                  name: update_at
                  type: DATETIME
                  defaultValueComputed: "CURRENT_TIMESTAMP"
                  constraints:
                    nullable: false
              - column:
                  name: firstname
                  type: VARCHAR(100)
                  constraints:
                    nullable: false
              - column:
                  name: lastname
                  type: VARCHAR(100)
              - column:
                  name: birthday
                  type: DATE
                  constraints:
                    nullable: false
              - column:
                  name: email
                  type: VARCHAR(150)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: phone_number
                  type: VARCHAR(30)
                  constraints:
                    nullable: false
                    unique: true
              - column:
                  name: role
                  type: VARCHAR(50)
                  constraints:
                    nullable: false
              - column:
                  name: password
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: staff_id
                  type: VARCHAR(50)
              - column:
                  name: position
                  type: VARCHAR(150)

  # ──────────────────────────────────────────────────────────────
  # Books
  # ──────────────────────────────────────────────────────────────
  - changeSet:
      id: 004-books
      author: steve
      comment: "Create books table"
      changes:
        - createTable:
            tableName: books
            columns:
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: create_at
                  type: DATETIME
                  defaultValueComputed: "CURRENT_TIMESTAMP"
                  constraints:
                    nullable: false
              - column:
                  name: update_at
                  type: DATETIME
                  defaultValueComputed: "CURRENT_TIMESTAMP"
                  constraints:
                    nullable: false
              - column:
                  name: title
                  type: VARCHAR(255)
                  constraints:
                    nullable: false
              - column:
                  name: author
                  type: VARCHAR(200)
                  constraints:
                    nullable: false
              - column:
                  name: publication_year
                  type: DATE
              - column:
                  name: num_of_copies
                  type: INT
                  constraints:
                    nullable: false
              - column:
                  name: available_copies
                  type: INT
              - column:
                  name: gender_id
                  type: BIGINT
                  constraints:
                    nullable: false

        - addForeignKeyConstraint:
            baseTableName: books
            baseColumnNames: gender_id
            referencedTableName: genders
            referencedColumnNames: id
            constraintName: fk_books_gender

  # ──────────────────────────────────────────────────────────────
  # Loans
  # ──────────────────────────────────────────────────────────────
  - changeSet:
      id: 005-loans
      author: steve
      comment: "Create loans table"
      changes:
        - createTable:
            tableName: loans
            columns:
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: create_at
                  type: DATETIME
                  defaultValueComputed: "CURRENT_TIMESTAMP"
                  constraints:
                    nullable: false
              - column:
                  name: update_at
                  type: DATETIME
                  defaultValueComputed: "CURRENT_TIMESTAMP"
                  constraints:
                    nullable: false
              - column:
                  name: loan_date
                  type: DATE
                  constraints:
                    nullable: false
              - column:
                  name: return_date
                  type: DATE
              - column:
                  name: expected_return_date
                  type: DATE
                  constraints:
                    nullable: false
              - column:
                  name: is_active
                  type: BOOLEAN
                  defaultValueBoolean: true
              - column:
                  name: book_id
                  type: BIGINT
                  constraints:
                    nullable: false
              - column:
                  name: student_id
                  type: BIGINT
                  constraints:
                    nullable: false

        - addForeignKeyConstraint:
            baseTableName: loans
            baseColumnNames: book_id
            referencedTableName: books
            referencedColumnNames: id
            constraintName: fk_loans_book

        - addForeignKeyConstraint:
            baseTableName: loans
            baseColumnNames: student_id
            referencedTableName: students
            referencedColumnNames: id
            constraintName: fk_loans_student

  # ──────────────────────────────────────────────────────────────
  # Notifications
  # ──────────────────────────────────────────────────────────────
  - changeSet:
      id: 006-notifications
      author: steve
      comment: "Create notifications table"
      changes:
        - createTable:
            tableName: notifications
            columns:
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: create_at
                  type: DATETIME
                  defaultValueComputed: "CURRENT_TIMESTAMP"
                  constraints:
                    nullable: false
              - column:
                  name: update_at
                  type: DATETIME
                  defaultValueComputed: "CURRENT_TIMESTAMP"
                  constraints:
                    nullable: false
              - column:
                  name: title
                  type: VARCHAR(200)
              - column:
                  name: message
                  type: TEXT
              - column:
                  name: student_id
                  type: BIGINT
                  constraints:
                    nullable: false

        - addForeignKeyConstraint:
            baseTableName: notifications
            baseColumnNames: student_id
            referencedTableName: students
            referencedColumnNames: id
            constraintName: fk_notifications_student

  # ──────────────────────────────────────────────────────────────
  # History / Audit
  # ──────────────────────────────────────────────────────────────
  - changeSet:
      id: 007-history
      author: steve
      comment: "Create history / audit table"
      changes:
        - createTable:
            tableName: history
            columns:
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: create_at
                  type: DATETIME
                  defaultValueComputed: "CURRENT_TIMESTAMP"
                  constraints:
                    nullable: false
              - column:
                  name: update_at
                  type: DATETIME
                  defaultValueComputed: "CURRENT_TIMESTAMP"
                  constraints:
                    nullable: false
              - column:
                  name: status
                  type: VARCHAR(50)
              - column:
                  name: action
                  type: VARCHAR(100)
              - column:
                  name: description
                  type: TEXT


   # ──────────────────────────────────────────────────────────────
      # refresh token
   # ──────────────────────────────────────────────────────────────

  - changeSet:
      id: 2026-01-24-003-create-refresh-tokens
      author: steve
      comment: "Create refresh_tokens table for JWT refresh token storage"
      changes:
        - createTable:
            tableName: refresh_tokens
            columns:
              - column:
                  name: id
                  type: BIGINT
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false

              - column:
                  name: token
                  type: VARCHAR(767)
                  constraints:
                    nullable: false
                    unique: true

              - column:
                  name: expiry_date
                  type: DATETIME
                  constraints:
                    nullable: false

              - column:
                  name: revoked
                  type: BOOLEAN
                  defaultValueBoolean: false
                  constraints:
                    nullable: false

              - column:
                  name: student_id
                  type: BIGINT
                  constraints:
                    nullable: true

              - column:
                  name: admin_id
                  type: BIGINT
                  constraints:
                    nullable: true

              - column:
                  name: create_at
                  type: DATETIME
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false

              - column:
                  name: update_at
                  type: DATETIME
                  defaultValueComputed: CURRENT_TIMESTAMP
                  constraints:
                    nullable: false

        # Foreign keys
        - addForeignKeyConstraint:
            baseTableName: refresh_tokens
            baseColumnNames: student_id
            referencedTableName: students
            referencedColumnNames: id
            constraintName: fk_refresh_token_student

        - addForeignKeyConstraint:
            baseTableName: refresh_tokens
            baseColumnNames: admin_id
            referencedTableName: admins
            referencedColumnNames: id
            constraintName: fk_refresh_token_admin

        # Indexes for performance
        - createIndex:
            tableName: refresh_tokens
            indexName: idx_refresh_token_token
            columns:
              - column:
                  name: token
            unique: true

        - createIndex:
            tableName: refresh_tokens
            indexName: idx_refresh_token_expiry_date
            columns:
              - column:
                  name: expiry_date

        # Optional: index on revoked for cleanup queries
        - createIndex:
            tableName: refresh_tokens
            indexName: idx_refresh_token_revoked
            columns:
              - column:
                  name: revoked